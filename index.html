<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth and Deriv WebSocket</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
        }
        #content {
            padding: 20px;
        }
        #connect-button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div id="content">
        <h1>Connect to Deriv Trading WebSocket</h1>
        <button id="connect-button">Connect to Deriv WebSocket</button>
        <div id="status"></div>
    </div>

    <script>
        // OAuth variables
        const clientId = 'QSDAQPsfjphEvtT';  // Replace with your OAuth Client ID
        const redirectUri = 'https://binery555.github.io/overunder-02/';  // Replace with your redirect URI
        const oauthUrl = `https://oauth-provider.com/auth?client_id=${clientId}&redirect_uri=${redirectUri}&response_type=code&scope=profile`;

        let accessToken = null;

        // When the page loads, check if we have an OAuth code in the URL (from the redirect)
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');

        if (code) {
            // Step 1: Exchange authorization code for an access token
            const tokenUrl = 'https://oauth-provider.com/token';  // Replace with your OAuth provider's token URL
            const params = {
                client_id: clientId,
                client_secret: 'your-client-secret',  // Replace with your client secret
                code: code,
                redirect_uri: redirectUri,
                grant_type: 'authorization_code'
            };

            fetch(tokenUrl, {
                method: 'POST',
                body: new URLSearchParams(params),
            })
            .then(response => response.json())
            .then(data => {
                if (data.access_token) {
                    accessToken = data.access_token;
                    document.getElementById('status').innerHTML = 'OAuth successful! Now you can connect to Deriv WebSocket.';
                } else {
                    document.getElementById('status').innerHTML = 'OAuth failed. Please try again.';
                }
            })
            .catch(error => {
                console.error('Error fetching token:', error);
                document.getElementById('status').innerHTML = 'Error fetching token.';
            });
        }

        // Step 2: WebSocket connection to Deriv after OAuth
        function connectToDerivWebSocket() {
            if (!accessToken) {
                document.getElementById('status').innerHTML = 'Please authenticate via OAuth first.';
                return;
            }

            // Deriv WebSocket URL and access token (use it in the URL or headers)
            const wsUrl = `wss://ws.binaryws.com/websockets/v3?access_token=${accessToken}`;
            const socket = new WebSocket(wsUrl);

            socket.onopen = () => {
                console.log('WebSocket connected to Deriv');
                document.getElementById('status').innerHTML = 'Connected to Deriv WebSocket!';
                
                // Subscribe to live price (for example, EUR/USD)
                const subscribeMessage = {
                    "ticks": "FRXEURUSD"
                };
                socket.send(JSON.stringify(subscribeMessage));
            };

            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log('Received data:', data);
                if (data.tick) {
                    console.log('Price:', data.tick.quote);
                }
            };

            socket.onerror = (error) => {
                console.error('WebSocket Error:', error);
                document.getElementById('status').innerHTML = 'Error connecting to WebSocket.';
            };

            socket.onclose = () => {
                console.log('WebSocket connection closed');
                document.getElementById('status').innerHTML = 'Disconnected from WebSocket.';
            };
        }

        // When the user clicks the button, connect to the WebSocket
        document.getElementById('connect-button').addEventListener('click', () => {
            connectToDerivWebSocket();
        });

        // Step 3: Redirect to OAuth provider if no code is present
        if (!code) {
            window.location.href = oauthUrl;  // Redirect user to OAuth provider for authentication
        }
    </script>
</body>
</html>
